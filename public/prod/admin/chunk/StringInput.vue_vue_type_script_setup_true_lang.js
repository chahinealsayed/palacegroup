var C=Object.defineProperty;var G=(n,r,e)=>r in n?C(n,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[r]=e;var w=(n,r,e)=>(G(n,typeof r!="symbol"?r+"":r,e),e);import{B as A,c as d}from"./app.js";import{m as z}from"./index.js";import{r as B,u as v}from"./m6bdda40d8bd2cf5a.js";import{c as K,q as U,d as g,a as f,f as c,z as $,F as P,g as _,A as W,y as p,p as Q,r as b,k as V,v as T,b as J,G as X,e as F,t as Y}from"./mc55b2a42316522d6.js";import{K as j,J as Z}from"./ma6cfd38af5d4c661.js";import{b as x}from"./Button.js";function Ce(n,r,e,s=5){const t=Math.ceil(e/r),i=[];for(let a=1;a<=t;a++)if(t<=s)i.push(a);else{let l=Math.floor(s/2),o=Math.floor(s/2);if(s%2===0&&l--,n<=l)o+=l-n+1,l=n;else if(t<n+o){const u=n+o-t;o-=u,l+=u}(a===n||a>=n-l&&a<=n+o)&&i.push(a)}return i}function ee(n){return!!n&&typeof n.then=="function"}const[te,R]=d(),[se,re]=d(!1),[ie,ae]=d(n=>!0);class ne extends A{constructor(r){super(),this.field=r,this.init()}init(){}static assign(r){const e=new this(r);return r.rule(e),e}enabled(r=e=>!0){return ae(this,r),this}get isEnable(){const r=ie(this);return typeof r=="function"?r(this):r}skipOnEmpty(){return re(this,!0),this}get isSkipOnEmpty(){return se(this)}message(r){let e=null;if(typeof r=="string")e=r;else if(Array.isArray(r)){const[s,t]=r;e=s[t](this)}else typeof r=="function"&&(e=r(this));return ee(e)?e.then(s=>{R(this,s)}):R(this,e),this}createErrorMessage(r){return(te(this)??this.defaultMessage).replace(new RegExp("{attribute}","gm"),r)}execute(){}runValidation(){return new Promise(async r=>{let e=!0,s=null;this.isEnable&&(this.execute(),e=await this.validate(),e||(s=this.createErrorMessage(this.field.label))),r({valid:e,field:this.field,message:s})})}}class le extends ne{get defaultMessage(){return"{attribute} is required"}validate(){return new Promise(r=>{r(this.field.value!==""&&this.field.value!==null&&this.field.value!==void 0)})}}const[oe,ue]=d(""),[he,de]=d(""),[fe,S]=d(null),[ce,pe]=d(""),[me,D]=d([]),[be,ve]=d([]),[ye,ge]=d(!1),[Oe,we]=d(!1),[Ee,$e]=d(null),H=(n,r=null)=>{r||(r=n),n.events.beforeUpdate.dispatch({sender:r}),n.hasOwnProperty("parent")&&n.parent&&H(n.parent,r)},q=(n,r=null)=>{r||(r=n),n.events.afterUpdate.dispatch({sender:r}),n.hasOwnProperty("parent")&&n.parent&&q(n.parent,r)};class L extends A{constructor(e,s,t,i=""){super();w(this,"parent");ue(this,e),de(this,s),S(this,t),pe(this,i)}update(e){H(this),this.silentUpdate(e),ye(this)&&this.validate(),q(this)}silentUpdate(e){S(this,e)}get name(){return oe(this)}get label(){return he(this)}get value(){return fe(this)}get hint(){return ce(this)}get htmlLabel(){return`
        <span>${this.label}</span>
        ${this.rules.filter(e=>e instanceof le&&e.isEnable).length>0?`<strong class="required text" title="${this.label} is required">*</strong>`:""}
    `}rule(e){return ve(this,s=>(s.push(e),s)),this}get rules(){return be(this)}addError(...e){D(this,s=>[...new Set(s.concat(e))])}get errors(){return me(this)}clearErrors(){D(this,[])}get hasErrors(){return this.errors.length>0}touch(e=null){ge(this,!0)}blur(e){e.target.value&&we(this,!0),Oe(this)&&this.validate()}set component(e){$e(this,e)}forceUpdate(){var e,s;(s=(e=Ee(this))==null?void 0:e.proxy)==null||s.$forceUpdate()}toString(){return JSON.stringify({name:this.name,label:this.label,value:this.value,hint:this.hint},null,2)}validate(){return new Promise(e=>{this.events.beforeValidate.dispatch({sender:this}),this.clearErrors(),Promise.all(this.rules.map(s=>s.runValidation())).then(s=>{const t=s.reduce((i,a)=>i&&a.valid,!0);if(!t){const i=s.filter(a=>a.message!==null).map(a=>a.message);this.events.beforeError.dispatch({sender:this,messages:i}),this.addError(...i),this.events.afterError.dispatch({sender:this,messages:i})}this.events.afterValidate.dispatch({sender:this,valid:t}),this.forceUpdate(),e(t)})})}}const[m,ke]=d({}),[N,Ae]=d({}),[y,E]=d({});class Ge extends A{constructor(e,s=()=>{}){super();w(this,"validationRules",[]);w(this,"parent");this.initData=e,s(this),this.beforeCreate(),this.assignFieldsFromGetters(),this.generateRules(),this.afterCreate()}beforeCreate(){}afterCreate(){}[Symbol.iterator](){let e=-1;return{next:(function(){return e++,{done:this.fields.length===e,value:this.fields.at(e)}}).bind(this)}}assignFieldsFromGetters(){Object.getOwnPropertyNames(Object.getPrototypeOf(this)).filter(e=>this[e]instanceof L).forEach(e=>{const s=this[e];this.setField(s)}),this.data=this.initData}generateRules(){for(let e of this.rules){let[s,t,i=a=>a]=e;s.forEach(a=>{this.validationRules.push(i(t.assign(a)))})}}setField(e){ke(this,s=>(e.parent=this,s[e.name]=e,s))}createField(e,s,t=""){Object.defineProperty(this,e,{writable:!1,value:this.field(e,s,t)})}get fields(){return[...Object.values(m(this)),...Object.values(y(this)).map(e=>e.model)]}get length(){return this.fields.length}updateData(e){for(let s in m(this))e.hasOwnProperty(s)&&m(this)[s].update(e[s]);E(this,s=>{for(let t in s)e.hasOwnProperty(t)&&(Array.isArray(s[t].model)?Array.isArray(e[t])&&e[t].forEach((i,a)=>{s[t].model[a]||s[t].unlimited&&s[t].model.push(s[t].factory(i))}):s[t].model.data=e[t]);return s})}set data(e){this.updateData(e)}generateData(){return{...this.objectToData(m(this),(e,s)=>e[s],e=>e.value),...this.objectToData(y(this),(e,s)=>e[s].model,e=>e.data)}}get data(){return this.controlData(this.generateData())}controlData(e){return e}objectToData(e,s=(i,a)=>i[a],t=i=>i.data){return Object.keys(e).map(i=>{const a=s(e,i);return Array.isArray(a)?{[i]:a.map(l=>t(l))}:{[i]:t(a)}}).reduce((i,a)=>(i={...i,...a},i),{})}get relations(){return y(this)}findField(e){var s;return(s=m(this))!=null&&s.hasOwnProperty(e)?m(this)[e]:null}field(e,s,t=null,i=""){return this.findField(e)??new L(e,s,t,i)}hasOne(e,s){return E(this,t=>(t.hasOwnProperty(e)||(t[e]={factory:s,model:s(this.initData[e]??{}),unlimited:!1}),t[e].model.parent=this,t)),y(this)[e].model}hasMany(e,s,t=1){return E(this,i=>(i.hasOwnProperty(e)||(i[e]={factory:s,model:new Array(t).fill(null).map(()=>s(this.initData[e]??{})).map(a=>(a.parent=this,a)),unlimited:!0}),i)),y(this)[e].model}hasLocals(e){const s="locals";return E(this,t=>{var i,a,l,o,u;return t.hasOwnProperty(s)||(t[s]={factory:e,model:(u=(o=(l=(a=(i=z())==null?void 0:i.languages)==null?void 0:a.map)==null?void 0:l.call(a,h=>{var k;return e(((k=this.initData[s])==null?void 0:k.find(O=>O.language===h.value))??{language:h.value})}))==null?void 0:o.map)==null?void 0:u.call(o,h=>(h.parent=this,h)),unlimited:!1}),t}),y(this)[s].model}get errors(){const e=N(this);for(let s in this.relations){const{model:t}=this.relations[s];if(Array.isArray(t))for(let i in t){const a=t[i];a.hasErrors&&(e[s]||(e[s]=[]),e[s].push({index:i,errors:a.errors}))}else t.hasErrors&&(e[s]=t.errors)}return e}get hasErrors(){return Object.keys(N(this)).length>0}validate(){return new Promise(async e=>{this.events.beforeValidate.dispatch({sender:this}),this.fields.forEach(t=>{var i,a;Array.isArray(t)?t.forEach(l=>{var o,u;(u=(o=l.events)==null?void 0:o.beforeValidate)==null||u.dispatch({sender:this,field:l})}):(a=(i=t.events)==null?void 0:i.beforeValidate)==null||a.dispatch({sender:this,field:t})});const s=await this.validateModel(this);this.events.afterValidate.dispatch({sender:this}),this.fields.forEach(t=>{var i,a;Array.isArray(t)?t.forEach(l=>{var o,u;(u=(o=l.events)==null?void 0:o.afterValidate)==null||u.dispatch({sender:this,field:l})}):(a=(i=t.events)==null?void 0:i.afterValidate)==null||a.dispatch({sender:this,field:t})}),e(s)})}validateModel(e){return new Promise(async s=>{let t=!0;e.validationRules.forEach(i=>{i.field.clearErrors()});for await(const i of e.validationRules){const{valid:a,field:l,message:o}=await i.runValidation();t=t&&a,a||(Ae(this,u=>(u.hasOwnProperty(l.name)||(u[l.name]=[]),u[l.name].push(o),u)),i.field.addError(o),i.field.forceUpdate())}for(let i in e.relations){const a=e.relations[i].model;if(Array.isArray(a))for await(let l of a){const o=await l.validate();t=t&&o}else{const l=await a.validate();t=t&&l}}s(t)})}get primarykey(){var e;return((e=this.findField("id"))==null?void 0:e.value)??null}get isNewRecord(){return!this.primarykey}addRemoteErrors(e){if(Object.hasOwn(e,"xhr")&&Object.hasOwn(e.xhr,"responseJSON")&&typeof e.xhr.responseJSON=="object"&&Object.hasOwn(e.xhr.responseJSON,"details")&&typeof e.xhr.responseJSON.details=="object"){const s=m(this);Object.keys(e.xhr.responseJSON.details).forEach(t=>{if(Object.hasOwn(s,t)){const i=e.xhr.responseJSON.details[t];s[t].addError(...i),s[t].forceUpdate()}})}}getField(e){return this[e]??null}}function ze(n){const r=U();let e=B(null);const s=(l={})=>{const o=new n(l);o.events.afterValidate.listen(({sender:u})=>{var h;(h=r==null?void 0:r.proxy)==null||h.$forceUpdate()}),e.value=()=>o},t=()=>{e.value=null};return[K(()=>e.value?e.value():null),s,t]}const Me=["innerHTML"],Pe=g({inheritAttrs:!1,__name:"Label",props:{field:{}},setup(n){return(r,e)=>(f(),c("label",$({class:"form-label"},r.$attrs,{innerHTML:r.field.htmlLabel}),null,16,Me))}}),Ve={key:0},Fe=g({inheritAttrs:!1,__name:"Error",props:{field:{}},setup(n){return(r,e)=>r.field.hasErrors?(f(),c("div",$({key:0,class:"invalid-feedback d-block"},r.$attrs),[r.field.errors.length>1?(f(),c("ul",Ve,[(f(!0),c(P,null,_(r.field.errors,(s,t)=>(f(),c("li",{key:t},j(s),1))),128))])):(f(),c(P,{key:1},[W(j(r.field.errors.join("")),1)],64))],16)):p("",!0)}}),je=["innerHTML"],Re=g({inheritAttrs:!1,__name:"Hint",props:{field:{}},setup(n){return(r,e)=>r.field.hint?(f(),c("div",{key:0,innerHTML:r.field.hint,class:"pb-2 text-muted"},null,8,je)):p("",!0)}}),Se={class:"input-group"},De={key:0,class:"input-group-text"},Le={key:2,class:"input-group-text"},Ne=g({inheritAttrs:!1,__name:"FieldWrapper",props:{field:{},noLabel:{type:Boolean,default:!1}},setup(n){var s;const r=U();(s=n.field)==null||s.events.afterValidate.listen(()=>{var t;(t=r==null?void 0:r.proxy)==null||t.$forceUpdate()});const e=x(`${n.field.name}`);return Q(()=>{n.field&&r&&(n.field.component=r)}),(t,i)=>t.field?(f(),c("div",$({key:0,class:["field-wrapper",{[`field-wrapper-${t.field.name}`]:!0}]},t.$attrs),[t.field&&!t.noLabel?b(t.$slots,"label",{key:0},()=>[V(Pe,{field:t.field,for:v(e)},null,8,["field","for"])]):p("",!0),V(Re,{field:t.field},null,8,["field"]),T("div",Se,[t.$slots.before?(f(),c("div",De,[b(t.$slots,"before",{field:t.field})])):p("",!0),t.$slots.buttonBefore?b(t.$slots,"buttonBefore",{key:1,field:t.field}):p("",!0),b(t.$slots,"default",{id:v(e)}),t.$slots.after?(f(),c("div",Le,[b(t.$slots,"after",{field:t.field})])):p("",!0),t.$slots.buttonAfter?b(t.$slots,"buttonAfter",{key:3,field:t.field}):p("",!0)]),t.field&&t.field.hasErrors?(f(),J(Fe,{key:1,field:t.field},null,8,["field"])):p("",!0)],16)):p("",!0)}}),Be=["id","value","placeholder"],Ke=g({inheritAttrs:!1,__name:"StringInput",props:{field:{},noLabel:{type:Boolean},placeholder:{}},setup(n,{expose:r}){const e=n,{field:s,noLabel:t=!1,placeholder:i=e.field.label}=e,a=B(null),l=h=>{s.update(h.target.value)},o=h=>{s.touch(h)},u=h=>{s.blur(h)};return r({input:()=>a.value}),(h,k)=>(f(),J(Ne,{field:v(s),"no-label":v(t)},X({default:F(({id:O})=>[T("input",$({id:O,ref_key:"input",ref:a,class:["form-control",{"is-invalid":v(s).hasErrors}],value:v(s).value},h.$attrs,{onInput:l,onFocus:o,onBlur:u,autocomplete:"off",spellcheck:"false",placeholder:v(i)}),null,16,Be)]),_:2},[_(h.$slots,(O,M)=>({name:M,fn:F(I=>[b(h.$slots,M,Z(Y({...I})))])}))]),1032,["field","no-label"]))}});export{Ge as M,ne as R,Ke as _,le as a,Ne as b,ze as c,Ce as p};
